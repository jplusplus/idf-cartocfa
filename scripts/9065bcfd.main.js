(function(){var a;angular.module("app.animation",[]),angular.module("app.constant",[]),angular.module("app.config",[]),angular.module("app.controller",[]),angular.module("app.directive",[]),angular.module("app.filter",[]),angular.module("app.service",[]),angular.module("app.template",[]),a=angular.module("app",["ngRoute","ngResource","ngAnimate","ngSanitize","leaflet-directive","truncate","siyfion.sfTypeahead","angulartics","angulartics.google.analytics","app.animation","app.constant","app.controller","app.config","app.filter","app.service","app.directive","app.template"])}).call(this),angular.module("app.template").run(["$templateCache",function(a){"use strict";a.put("map.html",'<div class="map" ng-class="{ \'map--layout-single\': filters.selectedCfa }">\n    <div leaflet id="map" defaults="defaults" markers="markers.filtered" width="100%" height="100%"></div>\n</div>\n'),a.put("map.popup.html",'<div class="map__popup" ng-controller="PopupCtrl">\n    <h5 class="map__popup__title">{{cfa.name}}</h5>\n    <div class="slide" ng-hide="filters.selectedCfa && filters.selectedCfa.rne == cfa.rne">\n        <div class="map__popup__addr">\n            {{cfa.address}}\n            <div ng-show="cfa.cmp1">{{cfa.cmp1}}</div>\n            <div ng-show="cfa.cmp2">{{cfa.cmp2}}</div>\n            <div>{{cfa.insee}}, {{cfa.city}}</div>\n        </div>\n        <button class="btn btn-sm btn-default" ng-click="selectCfa(cfa.rne)">\n            PLUS D\'INFO\n        </button>\n    </div>\n</div>'),a.put("sidebar.filters.html",'<div class="sidebar__filters">\n    <form class="sidebar__filters__form sidebar__filters__form--search-name"\n          ng-submit="filterBy(\'name\', filterByName)"\n          ng-class="{ \'sidebar__filters__form--open\': shouldShowFilter(\'name\') }">\n        <h4 class="sidebar__filters__form__title" ng-click="toggleFilter(\'name\')">\n            Rechercher un CFA par son nom\n        </h4>\n        <a class="sidebar__filters__form__toggler"></a>\n        <div class="sidebar__filters__form__workspace slide" ng-show="shouldShowFilter(\'name\')">\n            <p>\n                Localisez-le sur la carte<br />et découvrez son offre de filières\n            </p>\n            <div class="form-horizontal" role="form">\n                <div class="form-group">\n                    <div class="col-xs-7">\n                        <label class="sr-only" for="search-name-input">Nom du CFA...</label>\n                        <input type="text"\n                               class="form-control"\n                               id="search-name-input"\n                               ng-model="filterByName"\n                               sf-typeahead\n                               autocomplete="off"\n                               datasets="places"\n                               options="{minLength:2, highlight: true}"\n                               placeholder="Nom du CFA..." />\n                    </div>\n                    <div class="col-xs-3">\n                        <button type="submit" class="btn btn-block btn-primary">Chercher</button>\n                    </div>\n                    <div class="col-xs-1">\n                        <button type="button"\n                                class="btn sidebar__filters__form__workspace__remove"\n                                ng-show="filterByName"\n                                ng-click="removeFilter([\'name\']); filterByName = null">\n                            X\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div class="alert alert-warning slide" ng-show="placeNotFound">\n                Aucun CFA ne correspond à ces critères.\n            </div>\n        </div>\n    </form>\n    <form class="sidebar__filters__form sidebar__filters__form--search-place"\n          ng-submit="setCenter(filterByAddress)"\n          ng-class="{ \'sidebar__filters__form--open\': shouldShowFilter(\'place\') }">\n        <h4 class="sidebar__filters__form__title" ng-click="toggleFilter(\'place\')">\n            Trouver les CFA près de votre entreprise\n        </h4>\n        <a class="sidebar__filters__form__toggler"></a>\n        <div class="sidebar__filters__form__workspace slide" ng-show="shouldShowFilter(\'place\')">\n            <p>\n                Entrez vous adresse pour trouver les établissements<br />\n                près de chez vous.\n            </p>\n            <div class="form-horizontal" role="form">\n                <div class="form-group">\n                    <div class="col-xs-7">\n                        <label class="sr-only" for="search-place-input">Votre adresse...</label>\n                        <input type="text"\n                               class="form-control"\n                               id="search-place-input"\n                               placeholder="Votre adresse..."\n                               ng-model="filterByAddress"\n                               sf-typeahead\n                               autocomplete="off"\n                               options="{minLength:3, highlight: true}"\n                               datasets="addr">\n                    </div>\n                    <div class="col-xs-3">\n                        <button type="submit" class="btn btn-block btn-primary">Chercher</button>\n                    </div>\n                    <div class="col-xs-1">\n                        <button type="button"\n                                class="btn sidebar__filters__form__workspace__remove"\n                                ng-show="filterByAddress"\n                                ng-click="removeFilter([\'place\']); filterByAddress = \'\'; setCenter(null)">\n                            X\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div class="alert alert-warning slide" ng-show="addrNotFound">\n                Aucune adresse ne correspond à votre recherche.\n            </div>\n        </div>\n    </form>\n    <form class="sidebar__filters__form sidebar__filters__form--search-sector"\n           ng-class="{ \'sidebar__filters__form--open\': shouldShowFilter(\'sector\') }">\n        <h4 class="sidebar__filters__form__title" ng-click="toggleFilter(\'sector\')">\n            Découvrir les filières\n        </h4>\n        <a class="sidebar__filters__form__toggler"></a>\n        <div class="sidebar__filters__form__workspace slide" ng-show="shouldShowFilter(\'sector\')">\n            <p>\n                Affichez les établissements correspondant<br />\n                aux critères de votre choix.\n            </p>\n            <div class="form-horizontal" role="form">\n                <div class="form-group clearfix">\n                    <label for="sector-input" class="col-xs-4 sidebar__filters__form__workspace__label control-label">\n                        Secteur<br />professionel\n                    </label>\n                    <div class="col-xs-6 sidebar__filters__form__workspace__dropdown">\n                        <button ng-click="toggleSector(\'sector\')"\n                                type="button"\n                                class="btn btn-block btn-default" id="sector-input">\n                            {{getActiveSector(\'Tous secteurs\') | characters:20 }}\n                        </button>\n                        <div class="panel sidebar__filters__form__workspace__dropdown__panel"\n                             ng-show="shouldShowSector(\'sector\')">\n                            <a class="sidebar__filters__form__workspace__dropdown__panel__header"\n                                ng-click="removeFilter([\'sector\', \'filiere\', \'level\'])">\n                                Tous secteurs\n                            </a>\n                            <ul class="list-unstyled sidebar__filters__form__workspace__dropdown__panel__list">\n                                <li ng-repeat="sector in getSectors() | orderBy:\'name\'" ng-if="sector.name !== \'Non défini\'">\n                                    <a ng-click="filterBy(\'sector\', sector.name)">\n                                        {{sector.name}}\n                                    </a>\n                                </li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="col-xs-1">\n                        <button type="button"\n                                class="btn sidebar__filters__form__workspace__remove"\n                                ng-show="filters.get(\'sector\')"\n                                ng-click="removeFilter([\'sector\', \'filiere\', \'level\'])">\n                            X\n                        </button>\n                    </div>\n                </div>\n                <div class="form-group clearfix" ng-if="getFilieres()">\n                    <label for="filiere-input" class="col-xs-4 sidebar__filters__form__workspace__label control-label">\n                        Filière\n                    </label>\n                    <div class="col-xs-6 sidebar__filters__form__workspace__dropdown">\n                        <button ng-click="toggleSector(\'filiere\')"\n                                type="button"\n                                class="btn btn-block btn-default"\n                                id="filiere-input">\n                            {{getActiveFiliere(\'Toutes filières\') | characters:20 }}\n                        </button>\n                        <div class="panel sidebar__filters__form__workspace__dropdown__panel"\n                             ng-show="shouldShowSector(\'filiere\')">\n                            <a class="sidebar__filters__form__workspace__dropdown__panel__header"\n                                ng-click="removeFilter([\'filiere\', \'level\'])">\n                                Toutes filières\n                            </a>\n                            <ul class="list-unstyled sidebar__filters__form__workspace__dropdown__panel__list">\n                                <li ng-repeat="filiere in getFilieres() | orderBy:\'name\'">\n                                    <a ng-click="filterBy(\'filiere\', filiere.name)">\n                                        {{filiere.name}}\n                                    </a>\n                                </li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="col-xs-1">\n                        <button type="button"\n                                class="btn sidebar__filters__form__workspace__remove"\n                                ng-show="filters.get(\'filiere\')"\n                                ng-click="removeFilter([\'filiere\', \'level\'])">\n                            X\n                        </button>\n                    </div>\n                </div>\n                <div class="form-group clearfix" ng-if="getLevels()">\n                    <label for="level-input" class="col-xs-4 sidebar__filters__form__workspace__label control-label">\n                        Niveau\n                    </label>\n                    <div class="col-xs-6 sidebar__filters__form__workspace__dropdown">\n                        <button ng-click="toggleSector(\'level\')"\n                                type="button"\n                                class="btn btn-block btn-default"\n                                id="level-input">\n                            {{getActiveLevel(\'Tous niveaux\') | characters:20 }}\n                        </button>\n                        <div class="panel sidebar__filters__form__workspace__dropdown__panel"\n                             ng-show="shouldShowSector(\'level\')">\n                            <a class="sidebar__filters__form__workspace__dropdown__panel__header"\n                                ng-click="removeFilter([\'level\'])">\n                                Tous niveaux\n                            </a>\n                            <ul class="list-unstyled sidebar__filters__form__workspace__dropdown__panel__list">\n                                <li ng-repeat="level in getLevels() | orderBy:\'name\'">\n                                    <a ng-click="filterBy(\'level\', level.name)">\n                                        {{level.name}}\n                                    </a>\n                                </li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="col-xs-1">\n                        <button type="button"\n                                class="btn sidebar__filters__form__workspace__remove"\n                                ng-show="filters.get(\'level\')"\n                                ng-click="removeFilter([\'level\'])">\n                            X\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </form>\n</div>\n'),a.put("sidebar.html",'<div class="sidebar" ng-class="{ \'sidebar--layout-single\': filters.selectedCfa }">\n    <div class="sidebar__banner">\n        <h1 class="sidebar__banner__title">\n            Les CFA<br /> de votre région\n        </h1>\n        <h2 class="sidebar__banner__subtitle" ng-show="filters.selectedCfa">\n            {{filters.selectedCfa.name}}\n        </h2>\n        <div class="sidebar__banner__markers"></div>\n        <a class="sidebar__banner__close" ng-show="filters.selectedCfa" ng-click="closeSingle()">\n            <i class="glyphicon glyphicon-remove"></i>\n        </a>\n        <div moving-background timeout=\'3000\' offset=\'40\' gap=\'390\' class="sidebar__banner__buildings">\n            <div class="sidebar__banner__buildings__label">\n                Explorez<br />\n                les centres de formation<br />\n                d\'apprentis\n            </div>\n        </div>\n    </div>\n    <div ng-include="\'sidebar.filters.html\'"></div>\n    <div ng-include="\'sidebar.single.html\'"></div>\n</div>\n'),a.put("sidebar.single.html",'<div class="sidebar__single" scrollbar>\n    <div class="sidebar__single__info">\n        <div class="sidebar__single__info__addr">\n            {{filters.selectedCfa.address}}\n            <div ng-show="filters.selectedCfa.cmp1">\n                {{filters.selectedCfa.cmp1}}\n            </div>\n            <div ng-show="filters.selectedCfa.cmp2">\n                {{filters.selectedCfa.cmp2}}\n            </div>\n            <div>{{filters.selectedCfa.insee}}, {{filters.selectedCfa.city}}</div>\n            <a href="http://{{filters.selectedCfa.website}}"\n               class="sidebar__single__info__website"\n               target="_blank"\n               ng-show="filters.selectedCfa.website !== \'\' && filters.selectedCfa.email != filters.selectedCfa.website">\n                <img src="images/link.png" /> {{filters.selectedCfa.website}}\n            </a>\n        </div>\n        <div class="sidebar__single__info__civ">\n            {{filters.selectedCfa.civility}}\n        </div>\n        <div class="sidebar__single__info__phone">\n            {{filters.selectedCfa.phone}}\n        </div>\n        <a href="mailto:{{filters.selectedCfa.email}}"\n           analytics-on="click"\n           analytics-category="CFA"\n           analytics-event="Mailto"\n           analytics-label="{{filters.selectedCfa.rne}} - {{filters.selectedCfa.name}}"\n           target="_blank"\n           class="sidebar__single__info__mailto"\n           ng-show="filters.selectedCfa.email !== \'\'">\n            <img src="images/mailto.png" /> {{filters.selectedCfa.email}}\n        </a>\n    </div>\n\n    <div class="sidebar__single__degrees">\n        <h4 class="sidebar__single__degrees__title">Les diplômes proposés par ce CFA</h4>\n        <p class="bottom30">affichés par secteurs professionels et par filières</p class="bottom30">\n        <ul class="list-unstyled">\n            <li ng-repeat="sector in filters.selectedCfa.details">\n                <h5 class="sidebar__single__degrees__sector"\n                    ng-class="{\'sidebar__single__degrees__sector--reduce\': sector.reduce}"\n                    ng-click="sector.reduce = !sector.reduce">\n                    {{sector.name}}\n                </h5>\n                <ul class="list-unstyled slide" ng-hide="sector.reduce">\n                    <li ng-repeat="filiere in sector.filieres">\n                        <h6 class="sidebar__single__degrees__sector__filiere">\n                            {{filiere.name}}\n                        </h6>\n                        <div class="sidebar__single__degrees__sector__degree"\n                             ng-class="{ \'sidebar__single__degrees__sector__degree--odd\': $odd }"\n                             ng-repeat="degree in filiere.degrees">\n                            {{degree.name}}\n                        </div>\n                    </li>\n                </ul>\n            </li>\n        </ul>\n    </div>\n\n    <pre ng-hide="true">{{filters.selectedCfa|json}}</pre>\n</div>\n')}]),function(){angular.module("app.animation").animation(".slide",["animations",function(a){return{beforeAddClass:function(b,c,d){return"ng-hide"===c&&jQuery(b).show().slideUp(a.slideDuration,d),null},removeClass:function(b,c,d){return"ng-hide"===c&&jQuery(b).hide().slideDown(a.slideDuration,d),null}}}])}.call(this),function(){angular.module("app.config").run(["$rootScope",function(a){return a.safeApply=function(a){var b;return b=this.$root.$$phase,"$apply"!==b&&"$digest"!==b?this.$apply(a):a&&"function"==typeof a?a():void 0}}])}.call(this),function(){var a;a=angular.module("app.config").config(["$httpProvider",function(a){return a.defaults.cache=!0}])}.call(this),function(){angular.module("app.config").config(["$analyticsProvider",function(a){return a.virtualPageviews(!1)}])}.call(this),function(){angular.module("app.constant").constant("animations",{slideDuration:300})}.call(this),function(){angular.module("app.constant").constant("icons",{"default":{iconUrl:"images/pointeur-general.png",iconSize:[27,36],shadowSize:[0,0],iconAnchor:[13.5,36]},address:{iconUrl:"images/pointeur-adresse.png",iconSize:[122,77],shadowSize:[0,0],iconAnchor:[61,77]}})}.call(this),function(){angular.module("app.directive").directive("movingBackground",["$timeout",function(a){return{restrict:"A",replace:!1,scope:{gap:"=",timeout:"=",offset:"="},link:function(b,c){var d;return d=function(){var e;return e=c.data("step")||1,c.css("background-position",-1*e*b.gap+1*b.offset),c.data("step",e+1),a(d,b.timeout)},a(d,b.timeout)}}}])}.call(this),function(){angular.module("app.directive").directive("scrollbar",function(){return{restrict:"AE",link:function(a,b){return b.jScrollPane({autoReinitialise:!0,hideFocus:!0,mouseWheelSpeed:20,verticalDragMinHeight:10})},template:'<div class="scrollbar"><div ng-transclude></div></div>',transclude:!0}})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("app.service").factory("Filters",function(){var b;return new(b=function(){function b(){this.active=a(this.active,this),this.get=a(this.get,this),this.activate=a(this.activate,this),this.set=a(this.set,this)}var c,d;return d={sector:null,filiere:null,level:null,name:null},c=null,b.prototype.selectedCfa=null,b.prototype.centers={"default":{lat:48.856583,lng:2.3510745,zoom:11},manual:{lat:48.856583,lng:2.3510745,zoom:11}},b.prototype.KEYS={SECTOR:["sector","filiere","level"],PLACE:["place"],NAME:["name"]},b.prototype.set=function(a,b){return d[a]=b,this.activate(_.contains(this.KEYS.SECTOR,a)?"sector":a)},b.prototype.activate=function(a){return c=a},b.prototype.get=function(a){return null!=a?d[a]:[d,c]},b.prototype.active=function(a){return null==a&&(a=c),d[a]},b}())})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty;angular.module("app.service").factory("Dataset",["$http","$rootScope","$q","icons","Filters",function(c,d,e,f,g){var h;return new(h=function(){function h(){this.generateTree=a(this.generateTree,this),this.generateMarkers=a(this.generateMarkers,this),this.getCfa=a(this.getCfa,this),this.generateAddrMarker=a(this.generateAddrMarker,this),this.updateFilteredMarkers=a(this.updateFilteredMarkers,this),this.crossData=a(this.crossData,this),this.isReady=a(this.isReady,this),this.deferred=e.defer(),c.get("data/degree-places.json").success(function(a){return function(b){return c.get("data/employers.json").success(function(c){var d,e,f,g;a.degrees=b,c=_.indexBy(c,"Code RNE"),g=[];for(e in a.degrees)f=a.degrees[e].rne,null!=c[f]?(d=c[f],""!==d["Téléphone Contact"]&&(a.degrees[e].phone=d["Téléphone Contact"]),""!==d["Email Contact"]&&(a.degrees[e].email=d["Email Contact"]),g.push(a.degrees[e].civility=""+d["Civilité Contact"]+" "+d["Prenom Contact"]+" "+d["Nom Contact"])):g.push(void 0);return g})}}(this)),c.get("data/degree-details.json").success(this.generateTree),c.get("data/rne-coord.json").success(this.generateMarkers),d.$watch(function(){return function(){return g.get()}}(this),this.updateFilteredMarkers,!0),d.$watch(function(){return function(){return g.centers.manual}}(this),this.generateAddrMarker,!0),d.$watch(this.isReady,this.crossData,!0)}return h.prototype.tree=[],h.prototype.details=[],h.prototype.degrees=[],h.prototype.markers={},h.prototype.isReady=function(){return null!=this.markers.all&&!_.isEmpty(this.tree)&&this.degrees.length},h.prototype.crossData=function(a){return a?(angular.forEach(this.degrees,function(a){return function(b){var c,d;return d=a.markers.all[b.rne],null!=d?(c=a.detailsById[b.id],null==d.slug&&(angular.extend(d,b),d.name=b.name,d.message=d.name,d.slug=a.slugify(d.name)),d.sectors.push(c.sector),d.filieres.push(c.filiere),d.levels.push(c.level),d.degrees.push(b.id)):void 0}}(this)),this.deferred.resolve()):void 0},h.prototype.updateFilteredMarkers=function(){var a,c,d,e,f,h,i,j,k;j=g.get(),c=j[0],a=j[1];for(d in c)b.call(c,d)&&(i=c[d],null===i&&delete c[d]);if(_.isEmpty(c))this.markers.filtered=this.markers.all||{};else{this.markers.filtered={},k=this.markers.all;for(h in k)if(b.call(k,h)){e=k[h],f=!0;for(d in c)b.call(c,d)&&(i=c[d],"sector"===a&&_.contains(g.KEYS.SECTOR,d)&&(f=f&&_.contains(e[d+"s"],i)),"name"===a&&_.contains(g.KEYS.NAME,d)&&(f=f&&-1!==e.slug.indexOf(this.slugify(i))));f&&(this.markers.filtered[h]=e)}}return this.generateAddrMarker()},h.prototype.generateAddrMarker=function(){var a,b;return b=g.centers,a=g.get()[1],null!=this.markers.filtered.addr&&delete this.markers.filtered.addr,"place"!==a||angular.equals(b.manual,b["default"])?void 0:this.markers.filtered.addr={icon:f.address,lat:b.manual.lat,lng:b.manual.lng}},h.prototype.getCfa=function(a,b){var c;return null==b&&(b=!0),c=e.defer(),this.deferred.promise.then(function(d){return function(){var e;return e=d.markers.all[a],b&&(e.details=_.filter(d.details,function(a){return _.contains(e.degrees,a.id)}),e.details=d.getTree(e.details)),c.resolve(e)}}(this)),c.promise},h.prototype.generateMarkers=function(a){var b,c,d,e;for(b={},d=0,e=a.length;e>d;d++)c=a[d],b[c.rne]={lat:1*c.lat,lng:1*c.lng,icon:f["default"],message:null,focus:!1,rne:c.rne,name:null,degrees:[],sectors:[],filieres:[],levels:[]};return this.markers.all=b,this.markers.filtered=b},h.prototype.generateTree=function(a){var b,c,d,e;for(this.details=a,this.detailsById={},e=this.details,c=0,d=e.length;d>c;c++)b=e[c],this.detailsById[b.id]=b;return this.tree=this.tree.concat(this.getTree(a))},h.prototype.getTree=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(l=[],k=_.pluck(a,"sector"),i={},e={},m=0,o=k.length;o>m;m++)if(h=k[m],null==i[h]){for(i[h]=1,j={name:h,filieres:[]},c=_.where(a,{sector:h}),f=_.pluck(c,"filiere"),n=0,p=f.length;p>n;n++)d=f[n],null==e[d]&&(e[d]=1,b=_.where(c,{filiere:d}),g=_.uniq(_.pluck(b,"level")),j.filieres.push({name:d,degrees:b,levels:_.map(g,function(a){return{name:a}})}));l.push(j)}return l},h.prototype.slugify=function(a){var b,c,d,e,f;if(null==a&&(a=""),null==a.replace)return"";for(a=a.replace(/^\s+|\s+$/g,""),a=a.toLowerCase(),b="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",d="aaaaeeeeiiiioooouuuunc------",c=e=0,f=b.length;f>=0?f>=e:e>=f;c=f>=0?++e:--e)a=a.replace(new RegExp(b.charAt(c),"g"),d.charAt(c));return a=a.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},h}())}])}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,c,d,e,f,g,h){this.scope=a,this.http=c,this.compile=d,this.location=e,this.Dataset=f,this.Filters=g,this.leafletData=h,this.updateCenter=b(this.updateCenter,this),this.updateBounds=b(this.updateBounds,this),this.markerPopupHtml="<div ng-include=\"'map.popup.html'\"></div>",this.scope.markers=this.Dataset.markers,this.scope.filters=this.Filters,this.scope.defaults={minZoom:9,maxZoom:14,zoomControl:!0,scrollWheelZoom:!1},this.scope.$watch("markers.filtered",this.updateBounds,!0),this.scope.$watch(function(a){return function(){return a.Filters.centers.manual}}(this),this.updateCenter,!0),this.scope.$watch(function(a){return function(){return a.location.search().rne}}(this),function(a){return function(b){return null!=b?a.Dataset.getCfa(b).then(function(b){return a.Filters.selectedCfa=b}):a.Filters.selectedCfa=null}}(this)),this.scope.$on("leafletDirectiveMap.click",function(a){return function(){return a.location.search("rne",null)}}(this)),this.scope.$on("leafletDirectiveMarker.popupopen",function(b){return function(c,d){var e,f;return f=d.markerName,a=b.scope.$new(!0),b.Dataset.getCfa(f,!1).then(function(b){return angular.extend(a,{cfa:b})}),e=angular.element(d.leafletEvent.popup._contentNode),e.html(b.markerPopupHtml),b.compile(e)(a),null==b.Filters.selectedCfa||b.Filters.selectedCfa.rne!==f?b.Filters.selectedCfa=null:void 0}}(this))}return a.$inject=["$scope","$http","$compile","$location","Dataset","Filters","leafletData"],a.prototype.updateBounds=function(){var a,b;return a=this.Filters.get()[1],b=_.map(this.scope.markers.filtered,function(a){return[a.lat,a.lng]}),b.length&&"place"!==a?this.leafletData.getMap("map").then(function(a){return a.fitBounds(b)}):this.updateCenter(this.Filters.centers.manual)},a.prototype.updateCenter=function(a){return this.leafletData.getMap("map").then(function(b){return b.setView(a,a.zoom)})},a}(),angular.module("app.controller").controller("MapCtrl",a)}.call(this),function(){var a;a=function(){function a(a,b,c){this.scope=a,this.location=b,this.Filters=c,this.scope.filters=this.Filters,this.scope.selectCfa=function(a){return function(b){return a.location.search("rne",b)}}(this)}return a.$inject=["$scope","$location","Filters"],a}(),angular.module("app.controller").controller("PopupCtrl",a)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,c,d,e,f,g,h){this.scope=a,this.rootScope=c,this.q=d,this.http=e,this.location=f,this.Filters=g,this.Dataset=h,this.getAddress=b(this.getAddress,this),this.getActiveLevel=b(this.getActiveLevel,this),this.getActiveFiliere=b(this.getActiveFiliere,this),this.getActiveSector=b(this.getActiveSector,this),this.getLevels=b(this.getLevels,this),this.getFilieres=b(this.getFilieres,this),this.getSectors=b(this.getSectors,this),this.removeFilter=b(this.removeFilter,this),this.filterBy=b(this.filterBy,this),this.setCenter=b(this.setCenter,this),this.empty=[],this.shouldShowFilter="sector",this.shouldShowSector=this.bounds={wn:[1.232294,49.256857],es:[3.580622,48.103566],ne:[49.256857,3.580622],sw:[48.103566,1.232294]},this.gmapBounds=this.bounds.wn.join(",")+","+this.bounds.es.join(","),this.gmapUrl="http://nominatim.openstreetmap.org/search?",this.gmapUrl+="format=json&",this.gmapUrl+="limit=10&",this.gmapUrl+="bounded=1&",this.gmapUrl+="osm_type=N&",this.gmapUrl+="viewbox="+this.gmapBounds+"&",this.placeEngine=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace((a.rne||"")+" "+(a.name||""))},queryTokenizer:Bloodhound.tokenizers.whitespace,local:[]}),this.addrEngine=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{dataType:"jsonp",url:""+this.gmapUrl+"q=%QUERY&json_callback=?",filter:function(a){var b,c;return c=[],b=[],angular.forEach(a,function(a){return a.display_name=a.display_name.replace(", France métropolitaine",""),a.display_name=a.display_name.replace(", France",""),a.display_name=a.display_name.replace(", Île-de-France",""),_.contains(c,a.display_name)?void 0:(b.push(a),c.push(a.display_name))}),b}}}),this.placeEngine.initialize(),this.addrEngine.initialize(),this.scope.places=[],this.scope.addr={displayKey:"display_name",source:this.addrEngine.ttAdapter()},this.scope.filters=this.Filters,this.scope.shouldShowFilter=function(a){return function(b){return a.shouldShowFilter===b}}(this),this.scope.shouldShowSector=function(a){return function(b){return a.shouldShowSector===b}}(this),this.scope.toggleFilter=function(a){return function(b){return a.shouldShowFilter=a.shouldShowFilter===b?null:b,a.Filters.activate(a.shouldShowFilter)}}(this),this.scope.toggleSector=function(a){return function(b){return a.shouldShowSector=a.shouldShowSector===b?null:b}}(this),this.scope.setCenter=this.setCenter,this.scope.closeSingle=function(a){return function(){return a.location.search("rne",null)}}(this),this.scope.filterBy=this.filterBy,this.scope.removeFilter=this.removeFilter,this.scope.getSectors=this.getSectors,this.scope.getFilieres=this.getFilieres,this.scope.getLevels=this.getLevels,this.scope.getActiveSector=this.getActiveSector,this.scope.getActiveFiliere=this.getActiveFiliere,this.scope.getActiveLevel=this.getActiveLevel,this.scope.trackEmailClick=this.trackEmailClick,this.scope.$watch(function(a){return function(){return a.Dataset.markers}}(this),function(a){return function(){var b;return null!=a.Dataset.markers.all?(b=_.map(_.values(a.Dataset.markers.all),function(a){return{name:a.name,rne:a.rne}}),a.placeEngine.clear(),a.placeEngine.add(b),a.scope.places={displayKey:"name",source:a.placeEngine.ttAdapter()},a.scope.placeNotFound="name"===a.shouldShowFilter&&_.isEmpty(a.Dataset.markers.filtered)):void 0}}(this),!0),this.scope.$on("typeahead:selected",function(a){return function(b,c){return null!=c?a.rootScope.safeApply(function(){switch(a.shouldShowFilter){case"name":return a.filterBy("name",c.name);case"place":return a.setCenter(c)}}):void 0}}(this))}return a.$inject=["$scope","$rootScope","$q","$http","$location","Filters","Dataset"],a.prototype.setCenter=function(a){return this.scope.addrNotFound=!1,null!==a?null!=a.lon?(angular.extend(this.Filters.centers.manual,{lng:1*a.lon,lat:1*a.lat}),angular.extend(this.Filters.centers.manual,{zoom:14})):this.getAddress(a).then(function(b){return function(c){return a=c[0],angular.extend(b.Filters.centers.manual,{lng:1*a.lon,lat:1*a.lat}),angular.extend(b.Filters.centers.manual,{zoom:14})}}(this),function(a){return function(){return a.scope.addrNotFound=!0}}(this)):(angular.extend(this.Filters.centers.manual,this.Filters.centers["default"]),null!=this.Dataset.markers.filtered.addr?delete this.Dataset.markers.filtered.addr:void 0)},a.prototype.filterBy=function(a,b){switch(null!=b.name&&(b=b.name),this.shouldShowSector=null,a){case"sector":this.removeFilter(["filiere","level"]);break;case"filiere":this.removeFilter(["level"])}return this.Filters.set(a,b)},a.prototype.removeFilter=function(a){var b,c,d,e;for(this.shouldShowSector=null,e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this.Filters.set(b,null));return e},a.prototype.getSectors=function(){return this.Dataset.tree},a.prototype.getFilieres=function(){var a;return a=_.findWhere(this.getSectors(),{name:this.Filters.active("sector")}),null!=a&&null!=a.filieres?a.filieres:this.empty},a.prototype.getLevels=function(){var a;return a=_.findWhere(this.getFilieres(),{name:this.Filters.active("filiere")}),null!=a&&null!=a.levels?a.levels:this.empty
},a.prototype.getActiveSector=function(a){return null==a&&(a="Tous"),this.Filters.active("sector")||a},a.prototype.getActiveFiliere=function(a){return null==a&&(a="Tous"),this.Filters.active("filiere")||a},a.prototype.getActiveLevel=function(a){return null==a&&(a="Tous"),this.Filters.active("level")||a},a.prototype.getAddress=function(a){var b,c;return b=this.q.defer(),null==a?b.reject("No value"):(null!=a.display_name&&(a=a.display_name),c=""+this.gmapUrl+"&q="+a+"&json_callback=JSON_CALLBACK",this.http.jsonp(c).then(function(){return function(a){return a.data.length?b.resolve(a.data):b.reject("No result")}}(this)),b.promise)},a}(),angular.module("app.controller").controller("SidebarCtrl",a)}.call(this);