(function(){var a;angular.module("app.animation",[]),angular.module("app.constant",[]),angular.module("app.config",[]),angular.module("app.controller",[]),angular.module("app.directive",[]),angular.module("app.filter",[]),angular.module("app.service",[]),a=angular.module("app",["ngRoute","ngResource","ngAnimate","ngSanitize","leaflet-directive","truncate","siyfion.sfTypeahead","angulartics","angulartics.google.analytics","app.animation","app.constant","app.controller","app.config","app.filter","app.service","app.directive"])}).call(this),function(){angular.module("app.animation").animation(".slide",["animations",function(a){return{beforeAddClass:function(b,c,d){return"ng-hide"===c&&jQuery(b).show().slideUp(a.slideDuration,d),null},removeClass:function(b,c,d){return"ng-hide"===c&&jQuery(b).hide().slideDown(a.slideDuration,d),null}}}])}.call(this),function(){angular.module("app.config").run(["$rootScope",function(a){return a.safeApply=function(a){var b;return b=this.$root.$$phase,"$apply"!==b&&"$digest"!==b?this.$apply(a):a&&"function"==typeof a?a():void 0}}])}.call(this),function(){angular.module("app.config").config(["$analyticsProvider",function(a){return a.virtualPageviews(!1)}])}.call(this),function(){angular.module("app.constant").constant("animations",{slideDuration:300})}.call(this),function(){angular.module("app.constant").constant("icons",{"default":{iconUrl:"images/pointeur-general.png",iconSize:[27,36],shadowSize:[0,0],iconAnchor:[13.5,36]},address:{iconUrl:"images/pointeur-adresse.png",iconSize:[122,77],shadowSize:[0,0],iconAnchor:[61,77]}})}.call(this),function(){angular.module("app.directive").directive("movingBackground",["$timeout",function(a){return{restrict:"A",replace:!1,scope:{gap:"=",timeout:"=",offset:"="},link:function(b,c){var d;return d=function(){var e;return e=c.data("step")||1,c.css("background-position",-1*e*b.gap+1*b.offset),c.data("step",e+1),a(d,b.timeout)},a(d,b.timeout)}}}])}.call(this),function(){angular.module("app.directive").directive("scrollbar",function(){return{restrict:"AE",link:function(a,b){return b.jScrollPane({autoReinitialise:!0,hideFocus:!0,mouseWheelSpeed:20,verticalDragMinHeight:10})},template:'<div class="scrollbar"><div ng-transclude></div></div>',transclude:!0}})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("app.service").factory("Filters",function(){var b;return new(b=function(){function b(){this.active=a(this.active,this),this.get=a(this.get,this),this.activate=a(this.activate,this),this.set=a(this.set,this)}var c,d;return d={sector:null,filiere:null,level:null,name:null},c=null,b.prototype.selectedCfa=null,b.prototype.centers={"default":{lat:48.856583,lng:2.3510745,zoom:11},manual:{lat:48.856583,lng:2.3510745,zoom:11}},b.prototype.KEYS={SECTOR:["sector","filiere","level"],PLACE:["place"],NAME:["name"]},b.prototype.set=function(a,b){return d[a]=b,this.activate(_.contains(this.KEYS.SECTOR,a)?"sector":a)},b.prototype.activate=function(a){return c=a},b.prototype.get=function(a){return null!=a?d[a]:[d,c]},b.prototype.active=function(a){return null==a&&(a=c),d[a]},b}())})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b={}.hasOwnProperty;angular.module("app.service").factory("Dataset",["$http","$rootScope","$q","icons","Filters",function(c,d,e,f,g){var h;return new(h=function(){function h(){this.generateTree=a(this.generateTree,this),this.generateMarkers=a(this.generateMarkers,this),this.getCfa=a(this.getCfa,this),this.generateAddrMarker=a(this.generateAddrMarker,this),this.updateFilteredMarkers=a(this.updateFilteredMarkers,this),this.crossData=a(this.crossData,this),this.isReady=a(this.isReady,this),this.deferred=e.defer(),c.get("data/degree-places.json").success(function(a){return function(b){return c.get("data/employers.json").success(function(c){var d,e,f,g;a.degrees=b,c=_.indexBy(c,"Code RNE"),g=[];for(e in a.degrees)f=a.degrees[e].rne,null!=c[f]?(d=c[f],""!==d["Téléphone Contact"]&&(a.degrees[e].phone=d["Téléphone Contact"]),""!==d["Email Contact"]&&(a.degrees[e].email=d["Email Contact"]),g.push(a.degrees[e].civility=""+d["Civilité Contact"]+" "+d["Prenom Contact"]+" "+d["Nom Contact"])):g.push(void 0);return g})}}(this)),c.get("data/degree-details.json").success(this.generateTree),c.get("data/rne-coord.json").success(this.generateMarkers),d.$watch(function(){return function(){return g.get()}}(this),this.updateFilteredMarkers,!0),d.$watch(function(){return function(){return g.centers.manual}}(this),this.generateAddrMarker,!0),d.$watch(this.isReady,this.crossData,!0)}return h.prototype.tree=[],h.prototype.details=[],h.prototype.degrees=[],h.prototype.markers={},h.prototype.isReady=function(){return null!=this.markers.all&&!_.isEmpty(this.tree)&&this.degrees.length},h.prototype.crossData=function(a){var c,d,e,f;if(a){f=this.markers.all;for(e in f)b.call(f,e)&&(d=f[e],c=_.where(this.degrees,{rne:e}),d.degrees=_.pluck(c,"id"),c.length&&(angular.extend(d,c[0]),d.name=c[0].name,d.message=d.name,d.slug=this.slugify(d.name)),angular.forEach(c,function(a){return function(b){var c;return c=a.detailsById[b.id],_.contains(d.sectors,c.sector)||d.sectors.push(c.sector),_.contains(d.filieres,c.filiere)||d.filieres.push(c.filiere),_.contains(d.levels,c.level)?void 0:d.levels.push(c.level)}}(this)));return this.deferred.resolve()}},h.prototype.updateFilteredMarkers=function(){var a,c,d,e,f,h,i,j,k;j=g.get(),c=j[0],a=j[1];for(d in c)b.call(c,d)&&(i=c[d],null===i&&delete c[d]);if(_.isEmpty(c))this.markers.filtered=this.markers.all||{};else{this.markers.filtered={},k=this.markers.all;for(h in k)if(b.call(k,h)){e=k[h],f=!0;for(d in c)b.call(c,d)&&(i=c[d],"sector"===a&&_.contains(g.KEYS.SECTOR,d)&&(f=f&&_.contains(e[d+"s"],i)),"name"===a&&_.contains(g.KEYS.NAME,d)&&(f=f&&-1!==e.slug.indexOf(this.slugify(i))));f&&(this.markers.filtered[h]=e)}}return this.generateAddrMarker()},h.prototype.generateAddrMarker=function(){var a,b;return b=g.centers,a=g.get()[1],"place"!==a||angular.equals(b.manual,b["default"])?null!=this.markers.filtered.addr?delete this.markers.filtered.addr:void 0:this.markers.filtered.addr={icon:f.address,lat:b.manual.lat,lng:b.manual.lng}},h.prototype.getCfa=function(a){var b;return b=e.defer(),this.deferred.promise.then(function(c){return function(){var d;return d=_.findWhere(c.markers.all,{rne:a}),d.details=_.filter(c.details,function(a){return _.contains(d.degrees,a.id)}),d.details=c.getTree(d.details),b.resolve(d)}}(this)),b.promise},h.prototype.generateMarkers=function(a){var b,c,d,e;for(b={},d=0,e=a.length;e>d;d++)c=a[d],b[c.rne]={lat:1*c.lat,lng:1*c.lng,icon:f["default"],message:null,focus:!1,rne:c.rne,name:null,degrees:[],sectors:[],filieres:[],levels:[]};return this.markers.all=b,this.markers.filtered=b},h.prototype.generateTree=function(a){var b,c,d,e;for(this.details=a,this.detailsById={},e=this.details,c=0,d=e.length;d>c;c++)b=e[c],this.detailsById[b.id]=b;return this.tree=this.tree.concat(this.getTree(a))},h.prototype.getTree=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(k=[],null!=b&&(a=_.filter(a,b)),j=_.uniq(_.pluck(a,"sector")),l=0,n=j.length;n>l;l++){for(h=j[l],i={name:h,filieres:[]},d=_.where(a,{sector:h}),f=_.uniq(_.pluck(d,"filiere")),m=0,o=f.length;o>m;m++)e=f[m],c=_.where(d,{filiere:e}),g=_.uniq(_.pluck(c,"level")),i.filieres.push({name:e,degrees:c,levels:_.map(g,function(a){return{name:a}})});k.push(i)}return k},h.prototype.slugify=function(a){var b,c,d,e,f;if(null==a&&(a=""),null==a.replace)return"";for(a=a.replace(/^\s+|\s+$/g,""),a=a.toLowerCase(),b="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",d="aaaaeeeeiiiioooouuuunc------",c=e=0,f=b.length;f>=0?f>=e:e>=f;c=f>=0?++e:--e)a=a.replace(new RegExp(b.charAt(c),"g"),d.charAt(c));return a=a.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")},h}())}])}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,c,d,e,f,g,h){this.scope=a,this.http=c,this.compile=d,this.location=e,this.Dataset=f,this.Filters=g,this.leafletData=h,this.updateCenter=b(this.updateCenter,this),this.updateBounds=b(this.updateBounds,this),this.markerPopupHtml="<div ng-include=\"'partials/map.popup.html'\"></div>",this.scope.markers=this.Dataset.markers,this.scope.filters=this.Filters,this.scope.defaults={minZoom:9,maxZoom:14,zoomControl:!0,scrollWheelZoom:!1},this.scope.$watch("markers.filtered",this.updateBounds),this.scope.$watch(function(a){return function(){return a.Filters.centers.manual}}(this),this.updateCenter,!0),this.scope.$watch(function(a){return function(){return a.location.search().rne}}(this),function(a){return function(b){return null!=b?a.Dataset.getCfa(b).then(function(b){return a.Filters.selectedCfa=b}):a.Filters.selectedCfa=null}}(this)),this.scope.$on("leafletDirectiveMap.click",function(a){return function(){return a.location.search("rne",null)}}(this)),this.scope.$on("leafletDirectiveMarker.popupopen",function(b){return function(c,d){var e,f;return f=d.markerName,a=b.scope.$new(),b.Dataset.getCfa(f),b.Dataset.getCfa(f).then(function(b){return angular.extend(a,{cfa:b})}),e=angular.element(d.leafletEvent.popup._contentNode),e.html(b.markerPopupHtml),b.compile(e)(a),b.Filters.selectedCfa.rne!==f?b.Filters.selectedCfa=null:void 0}}(this))}return a.$inject=["$scope","$http","$compile","$location","Dataset","Filters","leafletData"],a.prototype.updateBounds=function(){var a,b;return a=this.Filters.get()[1],b=_.map(this.scope.markers.filtered,function(a){return[a.lat,a.lng]}),b.length&&"place"!==a?this.leafletData.getMap("map").then(function(a){return a.fitBounds(b)}):this.updateCenter(this.Filters.centers.manual)},a.prototype.updateCenter=function(a){return this.leafletData.getMap("map").then(function(b){return b.setView(a,a.zoom)})},a}(),angular.module("app.controller").controller("MapCtrl",a)}.call(this),function(){var a;a=function(){function a(a,b,c){this.scope=a,this.location=b,this.Filters=c,this.scope.filters=this.Filters,this.scope.selectCfa=function(a){return function(b){return a.location.search("rne",b)}}(this)}return a.$inject=["$scope","$location","Filters"],a}(),angular.module("app.controller").controller("PopupCtrl",a)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,c,d,e,f,g,h){this.scope=a,this.rootScope=c,this.q=d,this.http=e,this.location=f,this.Filters=g,this.Dataset=h,this.getAddress=b(this.getAddress,this),this.getActiveLevel=b(this.getActiveLevel,this),this.getActiveFiliere=b(this.getActiveFiliere,this),this.getActiveSector=b(this.getActiveSector,this),this.getLevels=b(this.getLevels,this),this.getFilieres=b(this.getFilieres,this),this.getSectors=b(this.getSectors,this),this.removeFilter=b(this.removeFilter,this),this.filterBy=b(this.filterBy,this),this.setCenter=b(this.setCenter,this),this.empty=[],this.shouldShowFilter="sector",this.shouldShowSector=this.bounds={ne:[49.256857,3.580622],sw:[48.103566,1.232294]},this.gmapBounds=this.bounds.sw.join(",")+"|"+this.bounds.ne.join(","),this.gmapUrl="http://maps.googleapis.com/maps/api/geocode/json?region=fr&bounds=",this.gmapUrl=this.gmapUrl+this.gmapBounds,this.placeEngine=new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace((a.rne||"")+" "+(a.name||""))},queryTokenizer:Bloodhound.tokenizers.whitespace,local:[]}),this.addrEngine=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:""+this.gmapUrl+"&address=%QUERY",filter:function(a){return function(b){return _.filter(b.results,function(b){return a.inBounds(b.geometry.location)})}}(this)}}),this.placeEngine.initialize(),this.addrEngine.initialize(),this.inBounds=function(a){return function(b){return b.lat>a.bounds.sw[0]&&b.lat<a.bounds.ne[0]&&b.lng>a.bounds.sw[1]&&b.lng<a.bounds.ne[1]}}(this),this.scope.places=[],this.scope.addr={displayKey:"formatted_address",source:this.addrEngine.ttAdapter()},this.scope.filters=this.Filters,this.scope.shouldShowFilter=function(a){return function(b){return a.shouldShowFilter===b}}(this),this.scope.shouldShowSector=function(a){return function(b){return a.shouldShowSector===b}}(this),this.scope.toggleFilter=function(a){return function(b){return a.shouldShowFilter=a.shouldShowFilter===b?null:b,a.Filters.activate(a.shouldShowFilter)}}(this),this.scope.toggleSector=function(a){return function(b){return a.shouldShowSector=a.shouldShowSector===b?null:b}}(this),this.scope.setCenter=this.setCenter,this.scope.closeSingle=function(a){return function(){return a.location.search("rne",null)}}(this),this.scope.filterBy=this.filterBy,this.scope.removeFilter=this.removeFilter,this.scope.getSectors=this.getSectors,this.scope.getFilieres=this.getFilieres,this.scope.getLevels=this.getLevels,this.scope.getActiveSector=this.getActiveSector,this.scope.getActiveFiliere=this.getActiveFiliere,this.scope.getActiveLevel=this.getActiveLevel,this.scope.trackEmailClick=this.trackEmailClick,this.scope.$watch(function(a){return function(){return a.Dataset.markers}}(this),function(a){return function(){var b;return null!=a.Dataset.markers.all?(b=_.map(_.values(a.Dataset.markers.all),function(a){return{name:a.name,rne:a.rne}}),a.placeEngine.clear(),a.placeEngine.add(b),a.scope.places={displayKey:"name",source:a.placeEngine.ttAdapter()},a.scope.placeNotFound="name"===a.shouldShowFilter&&_.isEmpty(a.Dataset.markers.filtered)):void 0}}(this),!0),this.scope.$on("typeahead:selected",function(a){return function(b,c){return null!=c?a.rootScope.safeApply(function(){switch(a.shouldShowFilter){case"name":return a.filterBy("name",c.name);case"place":return a.setCenter(c)}}):void 0}}(this))}return a.$inject=["$scope","$rootScope","$q","$http","$location","Filters","Dataset"],a.prototype.setCenter=function(a){return this.scope.addrNotFound=!1,null!==a?null!=a.geometry?(angular.extend(this.Filters.centers.manual,a.geometry.location),angular.extend(this.Filters.centers.manual,{zoom:14})):this.getAddress(a).then(function(a){return function(b){var c;return b.length?(c=b[0].geometry,angular.extend(a.Filters.centers.manual,c.location),angular.extend(a.Filters.centers.manual,{zoom:14})):a.scope.addrNotFound=!0}}(this)):(angular.extend(this.Filters.centers.manual,this.Filters.centers["default"]),null!=this.Dataset.markers.filtered.addr?delete this.Dataset.markers.filtered.addr:void 0)},a.prototype.filterBy=function(a,b){switch(null!=b.name&&(b=b.name),this.shouldShowSector=null,a){case"sector":this.removeFilter(["filiere","level"]);break;case"filiere":this.removeFilter(["level"])}return this.Filters.set(a,b)},a.prototype.removeFilter=function(a){var b,c,d,e;for(this.shouldShowSector=null,e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this.Filters.set(b,null));return e},a.prototype.getSectors=function(){return this.Dataset.tree},a.prototype.getFilieres=function(){var a;return a=_.findWhere(this.getSectors(),{name:this.Filters.active("sector")}),null!=a&&null!=a.filieres?a.filieres:this.empty},a.prototype.getLevels=function(){var a;return a=_.findWhere(this.getFilieres(),{name:this.Filters.active("filiere")}),null!=a&&null!=a.levels?a.levels:this.empty},a.prototype.getActiveSector=function(a){return null==a&&(a="Tous"),this.Filters.active("sector")||a},a.prototype.getActiveFiliere=function(a){return null==a&&(a="Tous"),this.Filters.active("filiere")||a},a.prototype.getActiveLevel=function(a){return null==a&&(a="Tous"),this.Filters.active("level")||a},a.prototype.getAddress=function(a){var b,c;return b=this.q.defer(),null==a?b.reject("No value"):(c=""+this.gmapUrl+"&address="+a,this.http.get(c).then(function(a){return function(c){return c=_.filter(c.data.results,function(b){return a.inBounds(b.geometry.location)}),null!=c?b.resolve(c):b.reject("No result")}}(this)),b.promise)},a}(),angular.module("app.controller").controller("SidebarCtrl",a)}.call(this);